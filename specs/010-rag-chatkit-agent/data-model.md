# Data Model: RAG ChatKit Agent Integration

**Feature**: 010-rag-chatkit-agent  
**Date**: 2025-12-05

## Overview

This data model defines the entities and data structures for the RAG ChatKit Agent Integration feature. The model extends the Qdrant data model from feature 009-qdrant-setup and adds chat-specific entities for session management, queries, responses, and citations.

## Entities

### Chat Session

**Purpose**: Represents an ongoing conversation between a user and the AI agent.

**Attributes**:
- `session_id` (string, required): Unique identifier for the session, generated by ChatKit
- `client_secret` (string, required): OpenAI ChatKit client secret token for authentication
- `created_at` (datetime, required): Session creation timestamp
- `last_activity` (datetime, optional): Last message timestamp
- `thread_id` (string, optional): ChatKit thread identifier for conversation grouping
- `user_context` (dict, optional): Optional user metadata (not authenticated in MVP)

**Relationships**:
- Has many: User Query
- Has many: Agent Response

**Lifecycle**:
- Created: When user opens chat interface (ChatKit requests client_secret)
- Updated: On each message exchange (updates last_activity)
- Expired: After inactivity period (handled by ChatKit, not backend)
- Destroyed: When user closes chat or session expires

**Validation Rules**:
- `session_id` must be unique
- `client_secret` must be valid OpenAI ChatKit token format
- `created_at` must be in UTC

**Storage**:
- Backend: In-memory dictionary (MVP) or Redis (optional scaling)
- Frontend: Managed by ChatKit component

---

### User Query

**Purpose**: Represents a natural language question or message submitted by the user.

**Attributes**:
- `query_id` (string, required): Unique identifier for the query
- `session_id` (string, required): Reference to Chat Session
- `query_text` (string, required): The user's question or message
- `timestamp` (datetime, required): When the query was submitted
- `metadata` (dict, optional): Additional context (user agent, IP, etc.)

**Relationships**:
- Belongs to: Chat Session
- Has one: Agent Response

**Lifecycle**:
- Created: When user submits message in ChatKit
- Processed: When agent processes query
- Completed: When response is generated

**Validation Rules**:
- `query_text` must be non-empty (FR-016)
- `query_text` must not exceed reasonable length (e.g., 2000 characters)
- `session_id` must reference existing session

**Storage**:
- Transient: Stored in memory during processing
- Optional: Logged for debugging (FR-017)

---

### Retrieved Chunk

**Purpose**: Represents a piece of textbook content retrieved from Qdrant based on semantic similarity.

**Attributes**:
- `chunk_id` (string, required): Qdrant point ID (UUID)
- `text` (string, required): The chunk content text
- `module` (string, required): Source module name (e.g., "module-1-ros2-nervous-system")
- `file_id` (string, required): Source file identifier
- `file_title` (string, required): Source file title
- `section` (string, optional): Section heading
- `subsection` (string, optional): Subsection heading
- `url` (string, required): Docusaurus URL path to source content
- `similarity_score` (float, required): Cosine similarity score from Qdrant
- `chunk_type` (string, optional): Type of chunk (section, subsection, paragraph_group)
- `tags` (list[string], optional): Content tags from frontmatter

**Relationships**:
- Used by: Tool Result
- Referenced by: Citation

**Lifecycle**:
- Created: When content is embedded in Qdrant (feature 009)
- Retrieved: When Qdrant query returns chunk
- Used: When included in agent context

**Validation Rules**:
- `similarity_score` must be between 0.0 and 1.0
- `url` must be valid Docusaurus path
- `module` must match existing module structure

**Storage**:
- Persistent: Qdrant vector database (from feature 009)
- Transient: In memory during query processing

---

### Tool Result

**Purpose**: Represents the output from the Qdrant query tool function.

**Attributes**:
- `tool_call_id` (string, required): Agents SDK tool call identifier
- `query_text` (string, required): Original user query
- `query_embedding` (list[float], required): Generated embedding vector (1536 dimensions)
- `chunks` (list[RetrievedChunk], required): Retrieved chunks from Qdrant
- `max_results` (int, required): Maximum results requested (default: 5)
- `execution_time` (float, optional): Tool execution time in seconds
- `timestamp` (datetime, required): When tool was executed

**Relationships**:
- Used by: Agent Response
- Contains: Retrieved Chunk

**Lifecycle**:
- Created: When Qdrant query tool is called
- Used: When agent processes tool result
- Discarded: After response generation

**Validation Rules**:
- `chunks` must have at least 1 item if query matched content
- `chunks` must not exceed `max_results`
- `query_embedding` must have 1536 dimensions

**Storage**:
- Transient: In memory during agent execution
- Optional: Logged for debugging

---

### Agent Response

**Purpose**: Represents the final answer generated by the AI agent.

**Attributes**:
- `response_id` (string, required): Unique identifier for the response
- `query_id` (string, required): Reference to User Query
- `session_id` (string, required): Reference to Chat Session
- `response_text` (string, required): The generated answer text
- `citations` (list[Citation], required): Source citations from retrieved chunks
- `model_used` (string, required): LLM model identifier (e.g., "gemini-2.5-flash")
- `tokens_used` (int, optional): Token count for response generation
- `generation_time` (float, optional): Time to generate response in seconds
- `is_streaming` (bool, optional): Whether response was streamed
- `timestamp` (datetime, required): When response was generated

**Relationships**:
- Belongs to: User Query
- Belongs to: Chat Session
- Has many: Citation

**Lifecycle**:
- Created: When agent generates response
- Streamed: If streaming enabled, sent incrementally
- Completed: When full response is generated
- Displayed: When ChatKit renders response

**Validation Rules**:
- `response_text` must be non-empty
- `citations` must reference valid Retrieved Chunks
- `model_used` must match configured model

**Storage**:
- Transient: In memory during streaming
- Optional: Logged for debugging (FR-017)

---

### Citation

**Purpose**: Represents a reference to source textbook content used in generating an answer.

**Attributes**:
- `citation_id` (string, required): Unique identifier for citation
- `response_id` (string, required): Reference to Agent Response
- `chunk_id` (string, required): Reference to Retrieved Chunk
- `module` (string, required): Source module name
- `section` (string, optional): Section title
- `url` (string, required): Docusaurus URL to source content
- `excerpt` (string, optional): Relevant excerpt from source
- `similarity_score` (float, optional): Original similarity score

**Relationships**:
- Belongs to: Agent Response
- References: Retrieved Chunk

**Lifecycle**:
- Created: When agent includes chunk in response
- Displayed: When ChatKit renders citations
- Clicked: When user navigates to source

**Validation Rules**:
- `url` must be valid Docusaurus path
- `module` must match existing module structure
- `chunk_id` must reference valid Retrieved Chunk

**Storage**:
- Transient: Included in response payload
- Optional: Logged for analytics

---

## Data Flow

### Query Processing Flow

1. **User Query** created from ChatKit message
2. **Agent** receives query, decides to call tool
3. **Tool Result** created from Qdrant query
4. **Retrieved Chunks** extracted from Tool Result
5. **Agent Response** generated using chunks as context
6. **Citations** created from Retrieved Chunks used in response
7. **Response** streamed back to ChatKit

### Session Management Flow

1. **Chat Session** created when user opens chat
2. **Client Secret** generated via OpenAI Sessions API
3. **Session** tracked in backend (in-memory or Redis)
4. **User Queries** linked to session
5. **Agent Responses** linked to session
6. **Session** expires after inactivity (ChatKit managed)

---

## Validation Rules Summary

### Query Validation (FR-016)
- Query text must be non-empty
- Query text must not exceed 2000 characters
- Query must be associated with valid session

### Response Validation
- Response text must be non-empty
- Citations must reference valid chunks
- Model identifier must match configuration

### Session Validation
- Session ID must be unique
- Client secret must be valid format
- Session must not be expired

---

## Storage Strategy

### Persistent Storage
- **Qdrant**: Retrieved Chunks (from feature 009)
- **Logs**: Optional structured logging of queries/responses

### Transient Storage
- **In-Memory**: Chat Sessions, User Queries, Agent Responses (MVP)
- **Optional Redis**: Distributed session storage for scaling

### No Database Required
- MVP uses in-memory storage for sessions
- ChatKit manages frontend session state
- Optional Redis for production scaling

---

## Integration with Feature 009

This data model extends the Qdrant data model from feature 009-qdrant-setup:

- **Reuses**: Qdrant connection, collection management, query infrastructure
- **Extends**: Adds chat-specific entities (Session, Query, Response, Citation)
- **Integrates**: Retrieved Chunk entity references Qdrant point structure

The Qdrant point structure from feature 009 is used as the source for Retrieved Chunk entities.

