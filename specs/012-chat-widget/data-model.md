# Data Model: Custom Chat Widget

**Feature**: 012-chat-widget  
**Date**: 2025-01-27  
**Phase**: 1 - Design & Contracts

## Entities

### ChatSession

Represents an active conversation session between a user and the AI assistant.

**Attributes**:
- `sessionId` (string, required): Unique session identifier generated by backend
- `createdAt` (timestamp, required): Session creation timestamp (ISO 8601)
- `lastActivity` (timestamp, optional): Last message timestamp
- `messageCount` (number, optional): Total messages in session

**Storage**:
- Stored in browser `sessionStorage` with key `chatSessionId`
- Persists across page navigations within same browser tab
- Cleared when browser tab/window closes

**Lifecycle**:
1. Created when widget first opened (backend `/api/chat` endpoint)
2. Retrieved from sessionStorage on widget initialization
3. Used for all subsequent API calls in same session
4. Expires when browser tab closes (sessionStorage behavior)

**Validation Rules**:
- sessionId must be non-empty string
- sessionId format: UUID (validated by backend)

**State Transitions**:
- `initializing` → `active` (on successful session creation)
- `active` → `expired` (on tab close or sessionStorage clear)
- `active` → `error` (on backend session validation failure)

### ChatMessage

Represents a single message in a conversation.

**Attributes**:
- `id` (string, required): Unique message identifier (client-generated UUID)
- `text` (string, required): Message content
- `sender` (enum: "user" | "assistant", required): Message sender
- `timestamp` (timestamp, required): Message creation time (ISO 8601)
- `status` (enum: "sending" | "sent" | "error", optional): Message delivery status
- `citations` (array of Citation, optional): Source references (assistant messages only)
- `error` (ErrorInfo, optional): Error details (if status is "error")

**Storage**:
- Stored in React component state (messages array)
- Not persisted to storage (conversation history maintained by backend)
- Retrieved from backend on session reconnect

**Validation Rules**:
- text must be non-empty string (trimmed)
- text length: 1-2000 characters
- sender must be "user" or "assistant"
- citations only present for assistant messages

**State Transitions**:
- User message: `sending` → `sent` (on successful API call)
- User message: `sending` → `error` (on API failure)
- Assistant message: Always `sent` (received from backend)

### Citation

Represents a reference to textbook content.

**Attributes**:
- `id` (string, optional): Citation identifier
- `text` (string, required): Citation display text (e.g., "Module 1, Section 2.3")
- `url` (string, required): Link to referenced content (relative or absolute)
- `chapter` (string, optional): Chapter/module identifier
- `section` (string, optional): Section identifier
- `page` (number, optional): Page number if applicable

**Storage**:
- Embedded in ChatMessage.citations array
- Not stored independently

**Validation Rules**:
- text must be non-empty string
- url must be valid URL (relative or absolute)
- url should be internal textbook link (Docusaurus route)

**Relationships**:
- Belongs to ChatMessage (many-to-one)
- References textbook content (one-to-one with content section)

### ErrorInfo

Represents error information for failed operations.

**Attributes**:
- `type` (enum: "network" | "timeout" | "4xx" | "5xx" | "validation", required): Error category
- `message` (string, required): User-friendly error message
- `code` (number, optional): HTTP status code (for 4xx/5xx errors)
- `retryable` (boolean, required): Whether error can be retried
- `timestamp` (timestamp, required): Error occurrence time

**Storage**:
- Embedded in ChatMessage.error (for message errors)
- Stored in component state (for session/API errors)

**Validation Rules**:
- type must be one of defined enum values
- message must be non-empty string
- code required for 4xx/5xx error types

## Relationships

```
ChatSession (1) ──< (many) ChatMessage
ChatMessage (1) ──< (many) Citation
```

- One ChatSession contains many ChatMessages
- One ChatMessage can have many Citations (assistant messages only)
- Citations reference external textbook content (not stored in widget)

## Data Flow

### Session Creation Flow
1. Widget opens → Check sessionStorage for existing sessionId
2. If not found → Call backend `/api/chat` (implicit session creation on first message)
3. Backend returns sessionId → Store in sessionStorage
4. Subsequent messages use stored sessionId

### Message Flow
1. User types message → Validate (non-empty, ≤2000 chars)
2. Create ChatMessage with status "sending" → Add to messages array
3. Call backend `/api/chat` with message and sessionId
4. On success → Update message status to "sent", add assistant response
5. On error → Update message status to "error", show error message

### Citation Flow
1. Backend response includes citations array
2. Parse citations → Create Citation objects
3. Attach to assistant ChatMessage
4. Render as clickable links in UI
5. User clicks citation → Navigate using Docusaurus Link component

## Constraints

### Session Constraints
- Maximum one active session per browser tab
- Session expires on tab close (sessionStorage behavior)
- Session ID must be valid UUID format

### Message Constraints
- Maximum 2000 characters per message
- Messages must be non-empty (after trim)
- Maximum message history: Managed by backend (widget displays all received)

### Citation Constraints
- Citations only on assistant messages
- Citation URLs must be valid Docusaurus routes
- Maximum citations per message: No limit (backend-controlled)

## State Management

### Component State Structure
```typescript
interface ChatWidgetState {
  isOpen: boolean;              // Widget open/closed state
  sessionId: string | null;    // Current session ID
  messages: ChatMessage[];       // Conversation messages
  isLoading: boolean;           // Loading indicator state
  error: ErrorInfo | null;     // Current error (if any)
  inputValue: string;          // Current input field value
  characterCount: number;      // Character count for validation
}
```

### Session Storage Structure
```typescript
// sessionStorage key: "chatSessionId"
// Value: string (UUID session ID)
```

## Validation Rules Summary

| Entity | Field | Rule |
|--------|-------|------|
| ChatSession | sessionId | Non-empty string, UUID format |
| ChatMessage | text | 1-2000 characters, non-empty after trim |
| ChatMessage | sender | Must be "user" or "assistant" |
| Citation | text | Non-empty string |
| Citation | url | Valid URL (relative or absolute) |
| ErrorInfo | type | Must be one of: network, timeout, 4xx, 5xx, validation |

